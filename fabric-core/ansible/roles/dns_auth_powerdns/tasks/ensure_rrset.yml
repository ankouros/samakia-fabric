---
- name: Check rrset presence
  ansible.builtin.command:
    argv:
      - python3
      - -c
      - |
        import json
        import sys

        zone = sys.argv[1].rstrip(".")
        name = sys.argv[2].rstrip(".")
        rtype = sys.argv[3]
        ttl = str(sys.argv[4])
        values = [str(v).rstrip(".") for v in json.loads(sys.argv[5])]

        present = set()
        for raw in sys.stdin.read().splitlines():
          line = raw.strip()
          if not line or line.startswith(";"):
            continue
          parts = line.split()
          if len(parts) < 5:
            continue
          rec_name, rec_ttl, rec_class, rec_type, rec_value = parts[0].rstrip("."), parts[1], parts[2], parts[3], parts[4].rstrip(".")
          if rec_type != rtype:
            continue

          if name == "@":
            if rec_name not in ("@", zone):
              continue
          else:
            # pdnsutil may print owner names as FQDNs. Treat both relative and FQDN as equivalent.
            if rec_name != name and rec_name != f"{name}.{zone}":
              continue

          present.add((rec_ttl, rec_value))

        missing = [v for v in values if (ttl, v) not in present]
        if missing:
          print(json.dumps(missing))
          sys.exit(1)
        sys.exit(0)
      - "{{ dns_auth_powerdns_zone_name }}"
      - "{{ dns_auth_powerdns_rrset.name }}"
      - "{{ dns_auth_powerdns_rrset.type }}"
      - "{{ dns_auth_powerdns_rrset.ttl }}"
      - "{{ dns_auth_powerdns_rrset['values'] | to_json }}"
    stdin: "{{ dns_auth_powerdns_zone_dump_text }}"
  register: dns_auth_powerdns_rrset_check
  changed_when: false
  failed_when: false

- name: Replace rrset when missing
  ansible.builtin.command:
    argv: >-
      {{
        [
          'pdnsutil',
          'replace-rrset',
          dns_auth_powerdns_zone_name,
          dns_auth_powerdns_rrset.name,
          dns_auth_powerdns_rrset.type,
          (dns_auth_powerdns_rrset.ttl | string),
        ] + (dns_auth_powerdns_rrset['values'] | list)
      }}
  when: dns_auth_powerdns_rrset_check.rc != 0
  changed_when: true
