---
- name: Install PowerDNS authoritative packages
  ansible.builtin.apt:
    name:
      - pdns-server
      - pdns-backend-sqlite3
      - sqlite3
      - dnsutils
    state: present
    update_cache: true

- name: Ensure PowerDNS config dir exists
  ansible.builtin.file:
    path: /etc/powerdns/pdns.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Install Samakia PowerDNS config
  ansible.builtin.template:
    src: pdns-samakia.conf.j2
    # Must override any packaged `launch+=...` snippets (e.g. bindbackend).
    # We install our config last so `launch=gsqlite3` wins deterministically.
    dest: /etc/powerdns/pdns.d/zz-samakia.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart PowerDNS

- name: Remove legacy Samakia PowerDNS config filename (if present)
  ansible.builtin.file:
    path: /etc/powerdns/pdns.d/50-samakia.conf
    state: absent

- name: Disable packaged bind backend snippet (incompatible with sqlite-only deployment)
  ansible.builtin.file:
    path: /etc/powerdns/pdns.d/bind.conf
    state: absent

- name: Ensure PowerDNS SQLite DB parent dir exists
  ansible.builtin.file:
    path: /var/lib/powerdns
    state: directory
    owner: pdns
    group: pdns
    mode: "0755"

- name: Check if PowerDNS SQLite DB exists
  ansible.builtin.stat:
    path: /var/lib/powerdns/pdns.sqlite3
  register: dns_auth_powerdns_sqlite_db

- name: Initialize PowerDNS SQLite DB schema (first boot)
  ansible.builtin.command:
    argv:
      - sqlite3
      - /var/lib/powerdns/pdns.sqlite3
      - ".read /usr/share/pdns-backend-sqlite3/schema/schema.sqlite3.sql"
  changed_when: true
  when: not dns_auth_powerdns_sqlite_db.stat.exists

- name: Ensure PowerDNS SQLite DB ownership
  ansible.builtin.file:
    path: /var/lib/powerdns/pdns.sqlite3
    state: file
    owner: pdns
    group: pdns
    mode: "0640"

- name: Ensure PowerDNS is enabled and started
  ansible.builtin.service:
    name: pdns
    enabled: true
    state: started

###############################################################################
# Master zone provisioning (idempotent)
###############################################################################

- name: List existing zones (master)
  ansible.builtin.command:
    argv: ["pdnsutil", "list-all-zones"]
  register: dns_auth_powerdns_zones
  changed_when: false
  when: dns_auth_powerdns_role == "master"

- name: Create infra zone on master (if missing)
  ansible.builtin.command:
    argv:
      - pdnsutil
      - create-zone
      - "{{ dns_auth_powerdns_zone_name }}"
      - "dns-auth-1.{{ dns_auth_powerdns_zone_name }}."
  register: dns_auth_powerdns_create_zone
  changed_when: true
  when: dns_auth_powerdns_role == "master" and (dns_auth_powerdns_zone_name not in dns_auth_powerdns_zones.stdout_lines | default([]))

- name: Read zone records (master)
  ansible.builtin.command:
    argv: ["pdnsutil", "list-zone", "{{ dns_auth_powerdns_zone_name }}"]
  register: dns_auth_powerdns_zone_dump
  changed_when: false
  when: dns_auth_powerdns_role == "master"

- name: Ensure required rrsets exist on master
  ansible.builtin.include_tasks: ensure_rrset.yml
  loop: "{{ dns_auth_powerdns_rrsets }}"
  loop_control:
    label: "{{ item.name }} {{ item.type }}"
  vars:
    dns_auth_powerdns_rrset: "{{ item }}"
    dns_auth_powerdns_zone_dump_text: "{{ dns_auth_powerdns_zone_dump.stdout }}"
  when: dns_auth_powerdns_role == "master"

###############################################################################
# Slave zone provisioning (idempotent)
###############################################################################

- name: List existing zones (slave)
  ansible.builtin.command:
    argv: ["pdnsutil", "list-all-zones"]
  register: dns_auth_powerdns_zones_slave
  changed_when: false
  when: dns_auth_powerdns_role == "slave"

- name: Create slave zone (if missing)
  ansible.builtin.command:
    argv: ["pdnsutil", "create-slave-zone", "{{ dns_auth_powerdns_zone_name }}", "{{ dns_auth_powerdns_master_ip }}"]
  register: dns_auth_powerdns_create_slave
  changed_when: true
  when: dns_auth_powerdns_role == "slave" and (dns_auth_powerdns_zone_name not in dns_auth_powerdns_zones_slave.stdout_lines | default([]))

- name: Trigger AXFR retrieve on slave (when zone created)
  ansible.builtin.command:
    argv: ["pdns_control", "retrieve", "{{ dns_auth_powerdns_zone_name }}"]
  register: dns_auth_powerdns_retrieve
  changed_when: false
  when: dns_auth_powerdns_role == "slave"

- name: Verify slave answers for infra zone (best-effort wait)
  ansible.builtin.command:
    argv: ["dig", "@{{ dns_auth_powerdns_listen_ip }}", "{{ dns_auth_powerdns_zone_name }}", "SOA", "+short"]
  register: dns_auth_powerdns_slave_soa
  retries: 15
  delay: 2
  until: dns_auth_powerdns_slave_soa.stdout | trim != ""
  changed_when: false
  when: dns_auth_powerdns_role == "slave"

###############################################################################
# Extra zones (internal/shared)
###############################################################################

- name: Ensure extra zones (master + slave)
  ansible.builtin.include_tasks: ensure_zone.yml
  loop: "{{ dns_auth_powerdns_extra_zones }}"
  loop_control:
    loop_var: dns_auth_powerdns_zone
    label: "{{ dns_auth_powerdns_zone.name }}"
  when: dns_auth_powerdns_extra_zones | length > 0
