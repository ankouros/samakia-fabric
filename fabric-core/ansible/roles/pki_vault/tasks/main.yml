---
- name: Read vault root token from controller
  ansible.builtin.set_fact:
    pki_vault_root_token: "{{ lookup('file', lookup('env', 'HOME') ~ '/.config/samakia-fabric/vault/root-token') | trim }}"
  delegate_to: localhost
  no_log: true

- name: Ensure local PKI directory exists (controller)
  ansible.builtin.file:
    path: "{{ pki_vault_cert_dir }}"
    state: directory
    mode: "0700"
  delegate_to: localhost

- name: Enable PKI secrets engine (if missing)
  ansible.builtin.command:
    argv: ["vault", "secrets", "list", "-format=json"]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  register: vault_secrets
  changed_when: false
  no_log: true

- name: Enable PKI if not present
  ansible.builtin.command:
    argv: ["vault", "secrets", "enable", "-path={{ pki_vault_path }}", "pki"]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  when: vault_secrets.stdout is defined and (pki_vault_path ~ "/") not in (vault_secrets.stdout | from_json)
  changed_when: true
  no_log: true

- name: Check for existing PKI CA
  ansible.builtin.command:
    argv: ["vault", "read", "-format=json", "{{ pki_vault_path }}/cert/ca"]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  register: pki_vault_ca
  failed_when: false
  changed_when: false
  no_log: true

- name: Generate PKI root CA if missing
  ansible.builtin.command:
    argv: [
      "vault", "write", "-format=json",
      "{{ pki_vault_path }}/root/generate/internal",
      "common_name={{ pki_vault_common_name }}",
      "ttl={{ pki_vault_ttl }}"
    ]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  register: pki_vault_root
  when: pki_vault_ca.rc != 0
  changed_when: true
  no_log: true

- name: Configure PKI URLs
  ansible.builtin.command:
    argv: [
      "vault", "write",
      "{{ pki_vault_path }}/config/urls",
      "issuing_certificates={{ pki_vault_issuing_url }}/v1/{{ pki_vault_path }}/ca",
      "crl_distribution_points={{ pki_vault_issuing_url }}/v1/{{ pki_vault_path }}/crl"
    ]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  changed_when: false
  no_log: true

- name: Create PKI role for shared services
  ansible.builtin.command:
    argv: [
      "vault", "write",
      "{{ pki_vault_path }}/roles/{{ pki_vault_role_name }}",
      "allowed_domains={{ pki_vault_allowed_domains | join(',') }}",
      "allow_subdomains=true",
      "allow_ip_sans=true",
      "max_ttl=720h"
    ]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  changed_when: false
  no_log: true

- name: Export PKI CA cert to controller
  ansible.builtin.command:
    argv: ["vault", "read", "-field=certificate", "{{ pki_vault_path }}/cert/ca"]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  register: vault_ca_pem
  changed_when: false
  no_log: true

- name: Persist shared CA on controller
  ansible.builtin.copy:
    dest: "{{ pki_vault_ca_path }}"
    content: "{{ vault_ca_pem.stdout }}"
    mode: "0644"
  delegate_to: localhost
  no_log: true

- name: Check shared-edge pem on controller
  ansible.builtin.stat:
    path: "{{ pki_vault_edge_pem }}"
  delegate_to: localhost
  register: pki_vault_edge_pem_stat
  changed_when: false

- name: Issue shared-edge certificate from Vault PKI
  ansible.builtin.command:
    argv: [
      "vault", "write", "-format=json",
      "{{ pki_vault_path }}/issue/{{ pki_vault_role_name }}",
      "common_name={{ pki_vault_edge_cn }}",
      "ip_sans={{ pki_vault_edge_ip_sans }}"
    ]
  environment:
    VAULT_ADDR: "{{ pki_vault_api_addr }}"
    VAULT_CACERT: /etc/vault/ssl/shared-bootstrap-ca.crt
    VAULT_TOKEN: "{{ pki_vault_root_token }}"
  register: vault_edge_cert
  when: pki_vault_edge_pem_stat.stat.exists is not defined or not pki_vault_edge_pem_stat.stat.exists
  changed_when: true
  no_log: true

- name: Write shared-edge pem to controller
  ansible.builtin.copy:
    dest: "{{ pki_vault_edge_pem }}"
    mode: "0600"
    content: |
      {{ (vault_edge_cert.stdout | from_json).data.private_key }}
      {{ (vault_edge_cert.stdout | from_json).data.certificate }}
      {{ (vault_edge_cert.stdout | from_json).data.issuing_ca }}
  delegate_to: localhost
  when: vault_edge_cert is defined and vault_edge_cert.stdout is defined
  no_log: true
