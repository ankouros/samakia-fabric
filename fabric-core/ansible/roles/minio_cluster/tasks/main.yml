---
- name: Ensure required packages are installed
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - nftables
      - iproute2
    state: present
    update_cache: true

- name: Ensure MinIO group exists
  ansible.builtin.group:
    name: "{{ minio_cluster_group }}"
    state: present

- name: Ensure MinIO user exists
  ansible.builtin.user:
    name: "{{ minio_cluster_user }}"
    group: "{{ minio_cluster_group }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false
    state: present

- name: Ensure MinIO data directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ minio_cluster_user }}"
    group: "{{ minio_cluster_group }}"
    mode: "0750"
  loop: "{{ minio_cluster_data_dirs }}"

- name: Install MinIO binary (pinned)
  ansible.builtin.get_url:
    url: "{{ minio_cluster_minio_url }}"
    dest: /usr/local/bin/minio
    mode: "0755"
    owner: root
    group: root
    checksum: "{{ minio_cluster_minio_checksum }}"

- name: Resolve MinIO root credentials from controller env
  ansible.builtin.set_fact:
    minio_cluster_root_user: "{{ lookup('ansible.builtin.env', 'MINIO_ROOT_USER') | default('', true) }}"
    minio_cluster_root_password: "{{ lookup('ansible.builtin.env', 'MINIO_ROOT_PASSWORD') | default('', true) }}"
  no_log: true

- name: Fail if MinIO root credentials are not provided
  ansible.builtin.assert:
    that:
      - minio_cluster_root_user | length > 0
      - minio_cluster_root_password | length > 0
    fail_msg: "Missing MINIO_ROOT_USER / MINIO_ROOT_PASSWORD in runner environment."
    quiet: true

- name: Install MinIO environment file
  ansible.builtin.template:
    src: minio.env.j2
    dest: /etc/default/minio
    owner: root
    group: root
    mode: "0640"
  notify: Restart minio
  no_log: true

- name: Install MinIO systemd unit
  ansible.builtin.template:
    src: minio.service.j2
    dest: /etc/systemd/system/minio.service
    owner: root
    group: root
    mode: "0644"
  notify: Restart minio

- name: Install nftables rules (minio nodes)
  ansible.builtin.template:
    src: nftables.conf.j2
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart nftables

- name: Ensure nftables is enabled and started
  ansible.builtin.service:
    name: nftables
    enabled: true
    state: started

- name: Reload systemd units
  ansible.builtin.systemd:
    daemon_reload: true

- name: Ensure MinIO is enabled and started
  ansible.builtin.service:
    name: minio
    enabled: true
    state: started

- name: Wait for MinIO local health endpoint (node)
  ansible.builtin.command:
    argv:
      - curl
      - -fsS
      - "http://127.0.0.1:{{ minio_cluster_s3_port }}/minio/health/live"
  register: minio_cluster_health
  retries: 30
  delay: 2
  until: minio_cluster_health.rc == 0
  changed_when: false

- name: Detect uninitialized MinIO server state (root endpoint returns 503)
  ansible.builtin.command:
    argv:
      - curl
      - -sS
      - -o
      - /dev/null
      - -w
      - "%{http_code}"
      - "http://127.0.0.1:{{ minio_cluster_s3_port }}/"
  register: minio_cluster_root_http_code
  changed_when: false

- name: Restart MinIO if server is not initialized yet (mountpoints may have changed)
  ansible.builtin.service:
    name: minio
    state: restarted
  when: minio_cluster_root_http_code.stdout == "503"

- name: Wait for MinIO S3 API to be initialized (root endpoint must not be 503)
  ansible.builtin.command:
    argv:
      - curl
      - -sS
      - -o
      - /dev/null
      - -w
      - "%{http_code}"
      - "http://127.0.0.1:{{ minio_cluster_s3_port }}/"
  register: minio_cluster_root_http_code_ready
  retries: 60
  delay: 2
  until: minio_cluster_root_http_code_ready.stdout != "503"
  changed_when: false
