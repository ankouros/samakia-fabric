name: PR Validate

on:
  pull_request:

permissions:
  contents: read

jobs:
  validate:
    runs-on: self-hosted
    env:
      CI: "1"
      TF_IN_AUTOMATION: "1"
      FABRIC_REPO_ROOT: ${{ github.workspace }}
      TF_VAR_pm_api_url: ${{ secrets.PM_API_URL }}
      TF_VAR_pm_api_token_id: ${{ secrets.PM_API_TOKEN_ID }}
      TF_VAR_pm_api_token_secret: ${{ secrets.PM_API_TOKEN_SECRET }}
      TF_BACKEND_S3_ENDPOINT: ${{ secrets.TF_BACKEND_S3_ENDPOINT }}
      TF_BACKEND_S3_BUCKET: ${{ secrets.TF_BACKEND_S3_BUCKET }}
      TF_BACKEND_S3_REGION: ${{ secrets.TF_BACKEND_S3_REGION }}
      TF_BACKEND_S3_KEY_PREFIX: ${{ secrets.TF_BACKEND_S3_KEY_PREFIX }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_BACKEND_S3_CA_SRC: ${{ secrets.TF_BACKEND_S3_CA_SRC }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv unzip ripgrep
          python3 -m pip install --user pre-commit ansible
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.10.0"

      - name: Trust Proxmox CA
        run: |
          sudo cp ops/ca/proxmox-root-ca.crt /usr/local/share/ca-certificates/proxmox-root-ca.crt
          sudo update-ca-certificates

      - name: Trust S3 backend CA (if provided)
        run: |
          if [[ -n "${TF_BACKEND_S3_CA_SRC:-}" ]]; then
            bash ops/scripts/install-s3-backend-ca.sh
          fi

      - name: Policy gates
        run: make policy.check

      - name: Docs anti-drift checks
        run: make docs.operator.check

      - name: AI indexing offline (fixtures)
        run: make ai.index.offline TENANT=platform SOURCE=docs

      - name: AI n8n workflow validation
        run: make ai.n8n.validate

      - name: Phase 17 Step 6 acceptance (CI-safe)
        run: make phase17.step6.accept

      - name: AI MCP doctor
        run: make ai.mcp.doctor

      - name: Hardening checklist validate
        run: make hardening.checklist.validate

      - name: Hardening checklist summary
        run: make hardening.checklist.summary

      - name: Pre-commit
        run: pre-commit run --all-files

      - name: Lint
        run: bash fabric-ci/scripts/lint.sh

      - name: Validate
        run: bash fabric-ci/scripts/validate.sh

      - name: VM image contract checks
        run: make images.vm.validate.contracts

      - name: Consumer contract checks
        run: |
          make consumers.validate
          make consumers.ha.check
          make consumers.disaster.check
          make consumers.gameday.mapping.check
          make consumers.gameday.execute.policy.check

      - name: Tenant contract checks
        run: |
          make tenants.validate
          make tenants.capacity.validate TENANT=all
          make tenants.execute.policy.check
          make tenants.dr.validate

      - name: Binding contract checks
        run: make bindings.validate TENANT=all

      - name: Binding verify (offline)
        run: make bindings.verify.offline TENANT=all

      - name: Proposal contract checks
        run: |
          make proposals.validate PROPOSAL_ID=example

      - name: Self-service proposal contract checks
        run: |
          make selfservice.validate PROPOSAL_ID=example

      - name: Substrate contract checks
        run: make substrate.contracts.validate

      - name: Substrate capacity guard (contract-only)
        run: make substrate.capacity.guard TENANT=all

      - name: Substrate plan (CI-safe)
        run: make substrate.plan.ci

      - name: Substrate observe (read-only)
        run: make substrate.observe TENANT=all

      - name: Substrate observe compare (read-only)
        run: make substrate.observe.compare TENANT=all

      - name: Drift detection (offline, non-blocking)
        run: |
          TENANT=all DRIFT_OFFLINE=1 DRIFT_NON_BLOCKING=1 DRIFT_FAIL_ON=none DRIFT_REQUIRE_SIGN=0 \
            make drift.detect

      - name: Tenant drift summaries
        run: TENANT=all make drift.summary

      - name: Runtime evaluation (read-only)
        run: make runtime.evaluate TENANT=all

      - name: Runtime status summaries
        run: make runtime.status TENANT=all

      - name: SLO ingestion (offline)
        run: make slo.ingest.offline TENANT=all

      - name: SLO evaluation (read-only)
        run: make slo.evaluate TENANT=all

      - name: SLO alert readiness rules
        run: make slo.alerts.generate TENANT=all

      - name: Alert routing + formatting validation
        run: make alerts.validate

      - name: Drift alert routing validation
        run: make substrate.alert.validate

      - name: Upload drift artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tenant-drift-evidence
          path: |
            evidence/drift/**
            artifacts/tenant-status/**
          if-no-files-found: warn

      - name: Consumer readiness packets
        run: |
          make consumers.evidence
          make consumers.bundle
          make consumers.bundle.check

      - name: Upload consumer artifacts
        uses: actions/upload-artifact@v4
        with:
          name: consumer-readiness-and-bundles
          path: |
            evidence/consumers/**
            artifacts/consumer-bundles/**
          if-no-files-found: error

      - name: HA enforcement gate
        run: make ha.enforce.check ENV=samakia-prod
