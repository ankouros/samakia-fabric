name: Release Readiness Packet

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
      release_id:
        description: "Release identifier"
        required: true
      sign:
        description: "Sign evidence packet (0 or 1)"
        required: false
        default: "0"
      gpg_key:
        description: "GPG fingerprint (optional)"
        required: false

permissions:
  contents: read

jobs:
  readiness:
    runs-on: self-hosted
    env:
      CI: "1"
      TF_IN_AUTOMATION: "1"
      FABRIC_REPO_ROOT: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate packet
        id: packet
        run: |
          set -euo pipefail
          export EVIDENCE_SIGN="${{ inputs.sign }}"
          export EVIDENCE_GPG_KEY="${{ inputs.gpg_key }}"
          bash ops/scripts/release-readiness-packet.sh "${{ inputs.release_id }}" "${{ inputs.env }}"
          packet_dir="release-readiness/${{ inputs.release_id }}"
          echo "packet_dir=${packet_dir}" >>"$GITHUB_OUTPUT"

      - name: Upload packet
        uses: actions/upload-artifact@v4
        with:
          name: release-readiness-${{ inputs.env }}-${{ inputs.release_id }}
          path: ${{ steps.packet.outputs.packet_dir }}
