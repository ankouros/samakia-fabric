---
- name: Require apt snapshot URL
  ansible.builtin.fail:
    msg: "golden_base_apt_snapshot_url must be set to a snapshot mirror"
  when: golden_base_apt_snapshot_url | length == 0

- name: Configure apt snapshot sources (if provided)
  ansible.builtin.blockinfile:
    path: /etc/apt/apt.conf.d/99snapshot
    create: true
    mode: "0644"
    block: |
      Acquire::Check-Valid-Until "false";
  when: golden_base_apt_snapshot_url | length > 0

- name: Configure apt sources for snapshot (if provided)
  ansible.builtin.copy:
    dest: /etc/apt/sources.list
    owner: root
    group: root
    mode: "0644"
    content: |
      {% set codename = ansible_distribution_release | lower %}
      {% if ansible_distribution | lower == 'debian' %}
      deb {{ golden_base_apt_snapshot_url }} {{ codename }} main contrib non-free non-free-firmware
      deb {{ golden_base_apt_snapshot_url }} {{ codename }}-updates main contrib non-free non-free-firmware
      deb {{ golden_base_apt_snapshot_security_url }} {{ codename }}-security main contrib non-free non-free-firmware
      {% else %}
      deb {{ golden_base_apt_snapshot_url }} {{ codename }} main restricted universe multiverse
      deb {{ golden_base_apt_snapshot_url }} {{ codename }}-updates main restricted universe multiverse
      deb {{ golden_base_apt_snapshot_url }} {{ codename }}-security main restricted universe multiverse
      {% endif %}
  when: golden_base_apt_snapshot_url | length > 0

- name: Log apt snapshot source
  ansible.builtin.debug:
    msg: "Using APT snapshot: {{ golden_base_apt_snapshot_url }}"
  when: golden_base_apt_snapshot_url | length > 0

- name: Ensure minimal packages
  ansible.builtin.package:
    name: "{{ golden_base_minimal_packages }}"
    state: present

- name: Ensure image metadata directory
  ansible.builtin.file:
    path: "{{ golden_base_image_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Write image id
  ansible.builtin.copy:
    dest: "{{ golden_base_image_dir }}/image-id"
    content: "{{ golden_base_image_id }}\n"
    owner: root
    group: root
    mode: "0644"

- name: Write build info
  ansible.builtin.template:
    src: build-info.json.j2
    dest: "{{ golden_base_image_dir }}/build-info.json"
    owner: root
    group: root
    mode: "0644"

- name: Write image version stamp
  ansible.builtin.template:
    src: image-version.txt.j2
    dest: /etc/samakia-image-version
    owner: root
    group: root
    mode: "0444"

- name: Lock image version stamp
  ansible.builtin.command: chattr +i /etc/samakia-image-version
  changed_when: false

- name: Ensure journald persistent storage
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: '^Storage='
    line: 'Storage=persistent'
    create: true
    mode: "0644"

- name: Harden SSH daemon
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^{{ item.key }}"
    line: "{{ item.key }} {{ item.value }}"
    create: true
    mode: "0644"
  loop:
    - { key: "PasswordAuthentication", value: "no" }
    - { key: "PermitRootLogin", value: "prohibit-password" }
    - { key: "PubkeyAuthentication", value: "yes" }
  notify: Restart ssh

- name: Enable cloud-init services
  ansible.builtin.service:
    name: "{{ item }}"
    enabled: true
  loop:
    - cloud-init
    - cloud-config
    - cloud-final
  failed_when: false
